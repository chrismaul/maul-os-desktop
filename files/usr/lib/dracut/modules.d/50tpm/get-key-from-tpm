#!/bin/bash -x
for i in tpm_crb tpm_tis tpm_tis_core tpm rng_core
do
  echo "Loading module $i"
  modprobe $i
done

echo "Waiting for TPM Dev"

CNT=0
while [ ! -e /dev/tpm0 ] && [ "$CNT" -lt 10 ]
do
  /usr/bin/sleep 1
  echo "."
  CNT=$((CNT+1))
done

echo "Unlocking key"
export TPM2TOOLS_TCTI="device:/dev/tpm0"
tpm2_unseal -c 0x81000000 -p pcr:sha256:0,1,7 -o /tmp/crypto_keyfile.bin
echo "Finish unlocking key"
